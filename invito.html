<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invito #LUCA30</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-200">
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            const firebaseConfig = {
              apiKey: "AIzaSyDHt_0OZ5D-tEFj0CTKtROije15w6L1Zhc",
              authDomain: "festa-luca30-a1b2c.firebaseapp.com",
              projectId: "festa-luca30-a1b2c",
              storageBucket: "festa-luca30-a1b2c.appspot.com",
              messagingSenderId: "463454056685",
              appId: "1:463454056685:web:07287e769ce684ff9d9ce4"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.db = db;
            window.firestore = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            
            document.dispatchEvent(new CustomEvent('firebaseReady'));

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('root').innerHTML = `<div class="p-4 text-center bg-red-100 text-red-800">Errore di configurazione.</div>`;
        }
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const FinalLogoSVG = (props) => ( <svg id="Livello_2" data-name="Livello 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 977.46 688.95" {...props}><defs><linearGradient id="Sfumatura_senza_nome_11" data-name="Sfumatura senza nome 11" x1="647.58" y1="543.71" x2="647.58" y2="126.7" gradientUnits="userSpaceOnUse"><stop offset="0" stopColor="#a1722a"/><stop offset=".1" stopColor="#a97b31"/><stop offset=".46" stopColor="#c29746"/><stop offset=".77" stopColor="#d1a853"/><stop offset="1" stopColor="#d7af58"/></linearGradient><linearGradient id="Sfumatura_senza_nome_10" data-name="Sfumatura senza nome 10" x1="275.45" y1="543.9" x2="275.45" y2="126.7" gradientUnits="userSpaceOnUse"><stop offset="0" stopColor="#a1722a"/><stop offset="1" stopColor="#d7af58"/></linearGradient></defs><g id="Livello_1-2" data-name="Livello 1"><g><g><g opacity=".6"><g><path fill="#c9af8a" d="M914.34,113.94c-117.08-159.75-352.91-126.96-448.12,37.95-14.98,25.94-34.9,73.69-37.18,103.28-.36,4.71-1.41,7.97,2.21,11.99,2.59,2.88,32.71,18.56,40.19,23.8,21.38,14.99,40,33.11,60.75,48.78-6.29-106.85,25.82-304.01,173.19-280.26,114.48,18.45,160.75,162.27,164.13,263.03,31.02-24.63,65.12-45.02,102.32-58.99-4.9-51.83-26.45-107.24-57.48-149.59Z"/><path fill="#c9af8a" d="M448.52,329.91l44.33,35.65c9.59,13.24,35.67,27.29,42.86,40.84,4.77,8.99,7.81,41.26,11.46,55.01,18.69,70.27,74.22,153.05,153.58,159.08,107.63,8.18,151-99.96,163.49-188.74,1.98-14.08,.52-34.22,2.83-46.41,1.85-9.76,48.54-42.39,59.24-49.08,16.05-10.05,32.96-18.42,50.29-26.03,6.97,107.14-28.26,221.24-110.75,293-104.67,91.06-270.26,86.48-364.45-17.26-7.97-8.78-27.97-33.78-32.87-43.5-1.46-2.9-3.31-5.32-2.33-8.84,18.17-47.86,20.63-107.11,4.54-155.8-5.56-16.82-14.99-31.91-22.23-47.91Z"/></g></g><g><path opacity=".6" fill="#c9af8a" d="M83.5,96.61l224.66-3.03-182.16,219.07c27.78-.49,54.07-4.13,81.85.64,134.37,23.08,153.31,212.31,70.3,291.82.81.43,1.55,1,2.17,1.72,1.45,1.66,2.1,3.87,1.77,6.05l-1.76,11.74,2.72.12c4.03.17,7.21,3.5,7.18,7.54l-.05,8.54c-.02,4.1-3.33,7.41-7.42,7.46l-6.63.07-.51,2.93c2.13-.09,3.82-.16,5.35.1.24.04.48.1.71.16,5.24-1.91,10.41-3.97,15.5-6.18v-34.59c0-4.14,3.36-7.5,7.5-7.5h10c4.14,0,7.5,3.36,7.5,7.5v22.17c8.76-4.96,17.18-10.42,25.19-16.4,145.71-108.76,101.75-338.75-94.46-345.81-15.23-.55-30.94,3.56-44.44,2.61-3.69-.26-7.15,1.85-6.12-3.69L414.02,14.8c-7.99-1.31-15.49,2.25-23.27,2.55-80.84,3.12-180.75,4.26-261.16,0-13.75-.73-32.58-2.71-45.94-5.76C70.57,8.6,60.08.46,47.23,0L15.29,152.51l21.69,2.19c8.51-17.33,26.38-54.44,46.51-58.09Z"/><path fill="#c9af8a" d="M256.27,624.24l.4-2.55c-1.21.74-2.43,1.45-3.67,2.15l-.04.4h3.3Z"/><path fill="#c9af8a" d="M252.11,648.24h-2.9c-.23,1-.49,2.01-.75,3h3.25l.4-3Z"/><path opacity=".6" fill="#c9af8a" d="M210.18,666.79l-.04-7.34c0-.58.06-1.16.19-1.72,1.51-6.55,8.2-7.49,14.68-7.53l.23-1.95h-4.56c-2.13,0-4.16-.91-5.58-2.5s-2.1-3.71-1.87-5.82l.22-1.97c-21.2,3.76-45.27,2.7-72.14-4.55-62.66-16.91-86.45-77.55-96.8-135.84-6.72.23-21.21-3.27-23.9,3.91-3.7,35.63-16.37,72.89-19.85,108.14-.46,4.66-1.99,12.27,1.28,15.95,2.6,2.92,32.63,17.36,38.6,19.88,50.86,21.54,111.49,29.61,169.69,22.77-.09-.46-.14-.94-.15-1.43Z"/></g><g><path fill="url(#Sfumatura_senza_nome_11)" d="M410.21,126.7l112.06,4.44,121.93,314.56,121.5-315.01,110.51-3.99-.14,12.86c-19.13,5.26-41.94.99-47.99,24.51-4.76,18.52-1.13,40.23-.83,59.09,1.23,77.44,2.96,154.7,6,232,.62,15.73-1.81,46.49,6.1,59.9,6.87,11.63,32.14,11.96,44.2,13.8,3.4,1.07-.69,11.49.66,14.85l-66.46-4.05h-34.08s-63.53,3.61-63.53,3.61l-.79-1.22.79-12.92c13.12-2.85,39.87-1.66,46.24-15.76,5.92-13.12,2.14-45.96,1.84-61.18-1.58-80.15-1.85-163.1-7-243-.29-4.44,1.59-11.69-2-14.49l-133.67,346.05-13.87-1.02-129.47-336.02c-.74,19.49-.51,39.03-.97,58.54-1.17,49.58-2.34,99.23-3,149-.35,26.1-3.11,53.68-.91,79.83,2.82,33.63,23.68,34.04,51.93,38.07l.95,13.57c-31.99-.17-63.99-4.86-96.01-2.01-.65-.66,2.63-16.74,3.24-18.26s6.23-5.91,8.17-8.83c12.64-19.03,9.65-50.48,10.55-72.45,2.6-63.97,4.07-127.82,5-192,.32-21.82,5.18-66.34-2.78-85.14-8.73-20.64-28.53-20.45-48.18-23.32v-14Z"/><path fill="url(#Sfumatura_senza_nome_10)" d="M230.21,520.7c33.08-1.38,67.62,1.82,100.54.04,11.01-.6,25-2.55,35.14-6.86,30.86-13.12,43.9-60.45,55.45-89.04.78-.5,9.63.58,11.37.88,1.51.26,1.54-.72,1.53,1.49l-23.66,115.36c-4.28.13-8.63.31-12.91.17-90.19-3.01-179.79-3.12-269.95-.03-2.52.09-9.3,2.58-11.07.05l.5-13.63c24.5-4,43.64-.39,47.95-30.05,2.49-107.79.57-215.86.99-323.75-2.7-32.05-21.09-30.89-47.82-35.68l-.06-12.96,58.46,4.05h45.09s59.46-4.05,59.46-4.05v12.99c-13.04,2.47-37.81,2.89-45.83,14.68-2.29,3.36-5.17,12.96-5.17,16.83v349.5Z"/></g></g><g><path fill="#c9ad88" d="M238.68,666.74l-3.01,20.99h-8.99s3-20.99,3-20.99h-12.01s-.04-7.34-.04-7.34c.58-2.52,11.75-1.45,14.03-1.67l2.01-16.99h-13s.99-9.01.99-9.01h13.99s2.94-19.56,2.94-19.56l8.07-.44-2,20h18l3.14-19.86,8.86-.13-3,19.99,11.06.47-.05,8.54-12.86.13-2.88,16.41c.47,2.67,10.25,1.02,12.74,1.45l-1.67,8.04-12.89.9-4.1,20.1-7.34-.04,3-21h-18ZM260.68,640.74h-18c.25,4.36-2.93,12.08-2.81,15.74.04,1.22.38,1.55,1.31,2.26h16l1.31-1.69,2.19-16.31Z"/><path fill="#c9ad88" d="M619.68,688.74l-11.53-.96-8.08-20.09-40.73.02-8.13,19.08-11.53.96,35.15-77.83c3.37.02,8.5-1.45,10.73,1.44l34.1,77.39ZM595.68,658.74l-15.01-36c-7.61,10.63-11.47,24.15-16.99,36h32Z"/><path fill="#c9ad88" d="M722.44,610c50.73-7.37,48.88,86.8.19,78.29-32.66-5.71-33.08-73.51-.19-78.29ZM724.41,618.98c-18.27,3.35-18.24,35.93-12.51,49.04,6.86,15.67,26.41,15.74,33.65.1,7.55-16.32,4.22-53.79-21.15-49.14Z"/><path fill="#c9ad88" d="M382.68,610.74v50.5c0,1.25,2.89,7.72,3.81,9.19,8.02,12.89,29.87,11.87,37.23-1.15.52-.92,2.96-6.65,2.96-7.04v-51.5h10v50.5c0,1.82-3.09,9.81-4.18,11.82-10.98,20.27-44.59,21.46-55.65,1-1.09-2.02-4.18-10-4.18-11.82v-51.5h10Z"/><path fill="#c9ad88" d="M631.68,619.74l.14-8.86c1.06-.52,2.26-.89,3.44-1.04,8.39-1.07,32.61-1.18,40.97-.15,3.27.4,3.76,1.06,3.53,4.55-.29,4.51-23.67,27.4-22.08,28.49,17.33-.52,29.84,14.58,22.9,31.41-8.25,20-39.78,18.15-52.43,3.6l8.02-7.02c9.74,14.98,40.36,11.83,35.29-10.27-.86-3.75-9-9.71-12.29-9.71h-14.5l.52-6.98,19.48-24.02h-33Z"/><path fill="#c9ad88" d="M491.44,610c14-2.02,28.53.42,38.17,11.38l-6.43,7.34c-16.16-19.32-49.9-9.74-52.49,15.53-3.32,32.39,30.38,46.44,53.35,25.56l6.62,6.43c-31.89,29.61-81.7,3.9-68.48-40.5,3.6-12.09,16.67-23.92,29.26-25.74Z"/><polygon fill="#c9ad88" points="314.68 610.74 314.68 678.74 355.68 678.74 355.68 687.74 304.68 687.74 304.68 610.74 314.68 610.74"/></g></g></g></svg> );
        const XCircle = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>);
        const Download = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>);
        const MadeByLogoSVG = (props) => (<svg id="Livello_2" data-name="Livello 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 304.55 55.49" {...props}><g id="Livello_1-2" data-name="Livello 1"><g id="Avatar_Black" data-name="Avatar Black"><g><g><path d="M.96,1.04h-.96v2.37h.96c1.47,0,1.82,0,1.82,1.98v44.81c0,1.98-.46,1.98-1.82,1.98h-.96v2.29h9.88v-2.29h-.96c-1.36,0-1.82,0-1.82-1.98V5.38c0-1.98.35-1.98,1.82-1.98h.96V1.04H.96Z"/><path d="M50.95,41.8h-.96v.96c0,8.26-.53,8.75-4.72,8.75h-9.43V5.38c0-1.98.35-1.98,1.82-1.98h.96V1.04h-9.88v2.37h.96c1.47,0,1.82,0,1.82,1.98v44.81c0,1.98-.46,1.98-1.82,1.98h-.96v2.29h23.45v-12.67h-1.25Z"/><path d="M83.32,47.68h-.96v.96c0,2.4-1.07,3.89-2.79,3.89-1.62,0-2.44-3.22-2.44-9.56V1.04h-7.09v2.29h.96c1.36,0,1.82,0,1.82,1.98v28.69c0,12.04-4.36,18.53-8.47,18.53-4.85,0-5.23-6.98-5.23-9.12V1.04h-7.09v2.29h.96c1.36,0,1.82,0,1.82,1.98v37.08c0,7.59,4.01,13.1,9.54,13.1,3.7,0,6.82-2.22,9.14-6.48,1.19,5.26,3.75,6.48,5.86,6.48,3.9,0,5.68-3.55,5.68-6.85v-.96h-1.7Z"/><path d="M115.7,1.04h-.66l-.24.61-11.59,29.7L93.1,1.69l-.22-.65h-7.39v2.29h.96c1.36,0,1.82,0,1.82,1.98v44.88c0,1.98-.46,1.98-1.82,1.98h-.96v2.29h8.29v-2.29h-.96c-1.36,0-1.82,0-1.82-1.98V9.22s.02.05.03.08c1.71,4.99,4.55,13.32,9.4,27.63l-3.17,8.28c-1.05,2.55-.78,5.84.66,7.98.99,1.48,2.49,2.3,4.22,2.3,1.88,0,3.46-.82,4.58-2.38,1.55-2.16,1.98-5.58,1.05-8.31l-3.18-9.38,10.62-27.14v41.91c0,1.98-.39,1.98-1.82,1.98h-.96v2.29h9.88v-2.29h-.96c-1.36,0-1.82,0-1.82-1.98V5.31c0-1.98.46-1.98,1.82-1.98h.96V1.04h-6.59ZM103.72,51.35c-.58.9-1.45,1.17-1.61,1.19-.73,0-1.3-.31-1.73-.93-1.05-1.51-.98-4.35-.47-5.71l1.92-4.87c.59,1.77,1.24,3.68,1.95,5.67.67,1.96.65,3.57-.05,4.66Z"/><path d="M130.01,7.75c.27,0,.54-.04.8-.12,1.66-.51,2.68-2.54,2.31-4.62-.33-1.78-1.6-3.01-3.1-3.01h0c-.27,0-.54.04-.8.12-1.72.51-2.74,2.49-2.37,4.62.32,1.75,1.65,3.01,3.16,3.01Z"/><path d="M132.17,50.19V13.62c0-2.27-1.47-4.05-3.35-4.05h-3.75v2.29h.96c1.47,0,1.82,0,1.82,1.98v36.35c0,1.98-.46,1.98-1.82,1.98h-.96v2.29h9.88v-2.29h-.96c-1.36,0-1.82,0-1.82-1.98Z"/><path d="M167.39,1.04h-7.32v2.29h.96c1.36,0,1.82,0,1.82,1.98v36.94L144.53,1.6l-.26-.57h-6.53v2.29h.96c1.36,0,1.82,0,1.82,1.98v44.88c0,1.98-.46,1.98-1.82,1.98h-.96v2.29h8.29v-2.29h-.96c-1.36,0-1.82,0-1.82-1.98V9.5l20.47,45.41h1.85V5.31c0-1.98.39-1.98,1.82-1.98h.96V1.04h-.96Z"/><path d="M205.62,47.68h-.96v.96c0,2.87-1.41,3.89-2.73,3.89-1.66,0-2.5-3.22-2.5-9.56V15.68C199.42,8.45,195.91,0,186.02,0c-4.81,0-11.28,2.6-13.69,9.93l-.28.85.83.34,2.5,1.03,1.01.42.29-1.05c1.72-6.32,6.2-8.56,9.52-8.56,7.86,0,8.92,7.06,8.92,13.97v2.95c-9.7.18-24.82,3.27-24.82,20.67,0,8.8,5.07,14.94,12.32,14.94,5.54,0,9.81-3.14,12.72-9.34.66,6.2,2.79,9.34,6.37,9.34,4.12,0,5.62-4.1,5.62-6.85v-.96h-1.7ZM182.61,52.54c-5.09,0-8.01-4.37-8.01-11.99,0-15.83,14.62-17.89,20.51-18.08v4.61c0,5.97-.9,25.45-12.5,25.45Z"/><path d="M234.87,49.28l-12.8-19.41c.2.01.4.02.59.02,5.99,0,12.04-4.92,12.04-15.9,0-8.23-4.91-12.96-13.46-12.96h-12.55v2.29h.96c1.36,0,1.82,0,1.82,1.98v44.88c0,1.98-.46,1.98-1.82,1.98h-.96v2.29h9.88v-2.29h-.96c-1.36,0-1.82,0-1.82-1.98v-21.49l14.76,22.24c1.47,2.24,3.67,3.52,6.03,3.52h2.78v-2.29h-.96c-1.25,0-1.72-.27-3.52-2.89ZM221.58,26.49c-1.74,0-3.55-.61-5.37-1.83l-.42-.28V5.31c0-.84,2.07-1.32,5.68-1.32,3.17,0,8.52,2.14,8.52,10.15,0,7.16-3.54,12.35-8.41,12.35Z"/><path d="M246.22,7.75c.27,0,.54-.04.8-.12,1.66-.51,2.68-2.54,2.31-4.62-.33-1.78-1.6-3.01-3.1-3.01h0c-.27,0-.54.04-.8.12-1.72.51-2.74,2.49-2.37,4.62.32,1.75,1.65,3.01,3.16,3.01Z"/><path d="M250.21,52.17c-1.36,0-1.82,0-1.82-1.98V13.62c0-2.27-1.47-4.05-3.35-4.05h-3.75v2.29h.96c1.47,0,1.82,0,1.82,1.98v36.35c0,1.98-.46,1.98-1.82,1.98h-.96v2.29h9.88v-2.29h-.96Z"/></g><g><path d="M272.67,15.88c2.22-1.52,3.69-4.12,3.69-7.08,0-4.97-4.03-8.31-10.04-8.31-4.38,0-7.91,1.94-9.2,5.06-1.13,2.73-.32,5.84,2.16,8.32l.57.57,2.39-.9-.62-1.24c-1.17-2.32-1.26-4.51-.24-6.15.99-1.6,2.94-2.56,5.21-2.56,3.64,0,5.48,1.73,5.48,5.14,0,5.49-5.51,5.91-7.2,5.91h-1.24v3.13h1.24c4.09,0,8.45.51,8.45,6.6,0,4.77-3.38,6.9-6.73,6.9-2.27,0-4.22-.96-5.21-2.56-1.01-1.64-.93-3.83.24-6.15l.62-1.24-2.39-.9-.57.57c-2.48,2.48-3.29,5.59-2.16,8.32,1.29,3.12,4.82,5.06,9.2,5.06,4.69,0,11.29-3.1,11.29-9.99,0-4.67-2.36-7.22-4.94-8.48Z"/><path d="M287.53,1.09h-10.04v2.75h1.24c.48,0,.72.02.83.05.02.07.04.2.04.43v26.25c0,.23-.02.36-.04.42-.1.03-.32.06-.83.06h-1.24v2.7h10.04c12.55,0,17.02-8.41,17.02-16.29s-4.47-16.37-17.02-16.37ZM287.71,30.66c-2.55,0-3.47-.21-3.8-.35V4.56c.31-.13,1.22-.38,3.8-.38,5.65,0,12.25,3.48,12.25,13.28s-6.33,13.2-12.25,13.2Z"/></g><g><path d="M264.3,41.89h-1.52v-1.52c0-.69-.56-1.25-1.25-1.25s-1.25.56-1.25,1.25v1.52h-1.52c-.69,0-1.25.56-1.25,1.25s.56,1.25,1.25,1.25h1.52v1.52c0,.69.56,1.25,1.25,1.25s1.25-.56,1.25-1.25v-1.52h1.52c.69,0,1.25-.56,1.25-1.25s-.56-1.25-1.25-1.25Z"/><path d="M290.3,41.89h-1.52v-1.52c0-.69-.56-1.25-1.25-1.25s-1.25.56-1.25,1.25v1.52h-1.52c-.69,0-1.25.56-1.25,1.25s.56,1.25,1.25,1.25h1.52v1.52c0,.69.56,1.25,1.25,1.25s1.25-.56,1.25-1.25v-1.52h1.52c.69,0,1.25-.56,1.25-1.25s-.56-1.25-1.25-1.25Z"/><path d="M277.3,50.17h-1.52v-1.52c0-.69-.56-1.25-1.25-1.25s-1.25.56-1.25,1.25v1.52h-1.52c-.69,0-1.25.56-1.25,1.25s.56,1.25,1.25,1.25h1.52v1.52c0,.69.56,1.25,1.25,1.25s1.25-.56,1.25-1.25v-1.52h1.52c.69,0,1.25-.56,1.25-1.25s-.56-1.25-1.25-1.25Z"/><path d="M303.3,50.17h-1.52v-1.52c0-.69-.56-1.25-1.25-1.25s-1.25.56-1.25,1.25v1.52h-1.52c-.69,0-1.25.56-1.25,1.25s.56,1.25,1.25,1.25h1.52v1.52c0,.69.56,1.25,1.25,1.25s1.25-.56,1.25-1.25v-1.52h1.52c.69,0,1.25-.56,1.25-1.25s-.56-1.25-1.25-1.25Z"/></g></g></g></g></svg>);

        const QrModal = ({ guest, qrDataUrl, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose}>
                <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center relative" onClick={(e) => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                        <XCircle className="h-8 w-8" />
                    </button>
                    <h2 className="text-2xl font-bold mb-2">QR Code per {guest.name}</h2>
                    <p className="text-gray-600 mb-4">Mostra questo codice all'autista della navetta.</p>
                    <div className="p-2 border-4 border-gray-200 rounded-lg inline-block">
                        <img src={qrDataUrl} alt="QR Code" className="w-64 h-64 mx-auto" />
                    </div>
                    <p className="font-mono text-2xl mt-4 tracking-widest bg-gray-100 px-4 py-2 rounded-lg inline-block">{guest.shortId || guest.id.substring(0, 8).toUpperCase()}</p>
                </div>
            </div>
        );

        const InvitationPage = () => {
            const [guest, setGuest] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [qrDataUrl, setQrDataUrl] = useState('');
            const [isQrModalOpen, setIsQrModalOpen] = useState(false);
            const [isReturnTime, setIsReturnTime] = useState(false);
            const [isArrivalTime, setIsArrivalTime] = useState(false);
            const [returnRequestStatus, setReturnRequestStatus] = useState(null);
            const [arrivalRequestStatus, setArrivalRequestStatus] = useState(null);
            const invitationRef = useRef(null);
            const audioStarted = useRef(false);
            const synth = useRef(null);
            const [confirmedAdults, setConfirmedAdults] = useState(1);
            const [confirmedChildren, setConfirmedChildren] = useState(0);

            const initAudio = () => {
                if (!audioStarted.current) {
                    Tone.start();
                    synth.current = new Tone.Synth().toDestination();
                    audioStarted.current = true;
                }
            };

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const isTestMode = params.get('testmode') === 'true';

                if (isTestMode) {
                    setIsArrivalTime(true);
                    setIsReturnTime(true);
                    return; 
                }

                const checkTime = () => {
                    const now = new Date();
                    const arrivalStart = new Date('2025-08-02T20:00:00');
                    const arrivalEnd = new Date('2025-08-02T22:15:00');
                    const returnStart = new Date('2025-08-02T23:00:00');

                    if (now >= arrivalStart && now <= arrivalEnd) {
                        setIsArrivalTime(true);
                    } else {
                        setIsArrivalTime(false);
                    }

                    if (now >= returnStart) {
                        setIsReturnTime(true);
                    }
                };
                checkTime();
                const interval = setInterval(checkTime, 60000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                const { getDoc, doc, onSnapshot } = window.firestore;
                const params = new URLSearchParams(window.location.search);
                const guestId = params.get('id');
                const shouldAutoDownload = params.get('autodownload') === 'true';

                if (!guestId) {
                    setError('ID invitato non trovato.');
                    setLoading(false);
                    return;
                }

                const returnRequestRef = doc(window.db, "returnRequests", guestId);
                const unsubscribeReturn = onSnapshot(returnRequestRef, (doc) => {
                    if (doc.exists()) {
                        const newStatus = doc.data().status;
                        if (newStatus === 'arrived' && returnRequestStatus !== 'arrived') {
                            initAudio();
                            synth.current?.triggerAttackRelease("C5", "0.5");
                            document.title = "LA NAVETTA È QUI!";
                        }
                        setReturnRequestStatus(newStatus);
                    } else {
                        setReturnRequestStatus(null);
                        document.title = "Invito #LUCA30";
                    }
                });

                const arrivalRequestRef = doc(window.db, "arrivalRequests", guestId);
                const unsubscribeArrival = onSnapshot(arrivalRequestRef, (doc) => {
                    if (doc.exists()) {
                         const newStatus = doc.data().status;
                        if (newStatus === 'arrived' && arrivalRequestStatus !== 'arrived') {
                            initAudio();
                            synth.current?.triggerAttackRelease("C5", "0.5");
                            document.title = "LA NAVETTA È QUI!";
                        }
                        setArrivalRequestStatus(newStatus);
                    } else {
                        setArrivalRequestStatus(null);
                    }
                });

                const guestRef = doc(window.db, "guests", guestId);
                const unsubscribeGuest = onSnapshot(guestRef, (doc) => {
                    if (doc.exists()) {
                        const guestData = { id: doc.id, ...doc.data() };
                        setGuest(guestData);
                        setConfirmedAdults(guestData.confirmedAdults ?? guestData.adults ?? 1);
                        setConfirmedChildren(guestData.confirmedChildren ?? guestData.children ?? 0);
                        generateQrCode(guestData.id, () => {
                            if (shouldAutoDownload) {
                                setTimeout(() => handleDownload(guestData), 500);
                            }
                        });
                    } else {
                        setError("Invito non valido.");
                    }
                    setLoading(false);
                });

                return () => {
                    unsubscribeReturn();
                    unsubscribeArrival();
                    unsubscribeGuest();
                };
            }, [returnRequestStatus, arrivalRequestStatus]);

            const generateQrCode = (id, callback) => {
                try {
                    const qr = qrcode(0, 'M');
                    qr.addData(id);
                    qr.make();
                    setQrDataUrl(qr.createDataURL(5, 10), callback);
                } catch (e) { console.error("QR Code generation failed", e); }
            };

            const handleDownload = async (currentGuest) => {
                if (!invitationRef.current) return;
                const canvas = await window.html2canvas(invitationRef.current, { scale: 3 });
                const fileName = `invito-#LUCA30-${currentGuest.name.replace(/\s/g, '-')}.jpg`;
                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL('image/jpeg', 1.0);
                link.click();
            };
            
            const handleRsvp = async (status) => {
                initAudio();
                if (!guest) return;
                const { doc, updateDoc } = window.firestore;
                const guestRef = doc(window.db, "guests", guest.id);
                await updateDoc(guestRef, {
                    rsvpStatus: status,
                    confirmedAdults: Number(confirmedAdults),
                    confirmedChildren: Number(confirmedChildren)
                });
            };

            const handleCallShuttle = async (type) => {
                initAudio();
                if (!guest) return;
                const { doc, setDoc, serverTimestamp } = window.firestore;
                const collectionName = type === 'arrival' ? 'arrivalRequests' : 'returnRequests';
                const requestRef = doc(window.db, collectionName, guest.id);
                
                const adults = guest.rsvpStatus === 'confirmed' ? (guest.confirmedAdults || 0) : (guest.adults || 0);
                const children = guest.rsvpStatus === 'confirmed' ? (guest.confirmedChildren || 0) : (guest.children || 0);

                await setDoc(requestRef, {
                    guestName: guest.name,
                    guestId: guest.id,
                    adults: adults,
                    children: children,
                    status: 'requested',
                    createdAt: serverTimestamp()
                });
            };

            const eventDetails = {
                eventName: "#LUCA30",
                eventDate: "Sabato 2 Agosto 2025",
                eventTime: "Start ore 20:30",
                eventLocation: "SECRET LOCATION",
                dressCodeTitle: "Country Chic",
                dressCodeDesc: "Pensate ad una serata pugliese, non ad un rodeo texano. Comodi sì, ma con stile, in un look curato ma rilassato 😜",
                dressCodePalette: "Color palette: Bianco, Beige, Platino. -No Black-",
                shuttleInfo: "Data l'assenza di parcheggio, abbiamo pensato a tutto!\nLascia l'auto al Penny Market, Via Brindisi, 72019 San Vito dei Normanni BR.\nUna navetta ti porterà all'evento.",
                shuttleTiming: "Il servizio navetta sarà attivo dalle 20:00 alle 22:30.\nIl ritorno è garantito con la stessa modalità.",
                rsvpDate: "Sabato 26 Luglio 2025",
            };
            
            if (loading) return <div className="flex items-center justify-center h-screen text-gray-600"><p>Caricamento...</p></div>;
            if (error) return <div className="flex items-center justify-center h-screen p-4 text-center bg-red-100 text-red-700">{error}</div>;
            if (!guest) return null;

            const { name } = guest;
            const lowerCaseName = name.toLowerCase();
            const isGroup = lowerCaseName.includes('famiglia') || lowerCaseName.includes(' e ') || lowerCaseName.includes('&');
            const guestText = {
                greeting: isGroup ? 'Cari' : 'Caro/a',
                verb: isGroup ? 'potete' : 'puoi',
                possessive: isGroup ? 'vostro' : 'tuo'
            };

            return (
                <React.Fragment>
                    {isQrModalOpen && <QrModal guest={guest} qrDataUrl={qrDataUrl} onClose={() => setIsQrModalOpen(false)} />}
                    <div className="min-h-screen p-4 flex flex-col items-center justify-center" onClick={initAudio}>
                         <style>{`
                            @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Cinzel:wght@700&display=swap');
                            body { font-family: 'Cormorant Garamond', serif; }
                            .font-logo { font-family: 'Cinzel', serif; }
                            .golden-text {
                                background: -webkit-linear-gradient(45deg, #D4AF37, #C09526, #B8860B);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
                            }
                        `}</style>
                        <div ref={invitationRef} className="w-full max-w-md bg-white shadow-2xl rounded-lg flex flex-col text-center text-gray-700 relative overflow-hidden">
                            <div className="absolute top-0 left-0 h-full w-2 bg-gradient-to-b from-red-500 via-orange-500 via-yellow-400 via-green-500 via-blue-500 to-purple-600"></div>
                            <div className="absolute top-0 right-0 h-full w-2 bg-gradient-to-b from-red-500 via-orange-500 via-yellow-400 via-green-500 via-blue-500 to-purple-600"></div>
                            <div className="px-8 sm:px-10 py-6 flex-grow flex flex-col">
                                <div className="w-1/3 mx-auto mt-4"><FinalLogoSVG /></div>
                                <div className="mt-6 text-xl">
                                    <p>{guestText.greeting}, <span className="font-bold">{name}</span>,<br/> non {guestText.verb} mancare!</p>
                                    <p className="mt-2 text-lg text-gray-500">Questo è il {guestText.possessive} invito personale per <span className="font-bold golden-text">{eventDetails.eventName}</span>!</p>
                                </div>
                                <div className="my-8 text-center space-y-2">
                                    <p className="font-logo text-3xl font-bold tracking-wide">{eventDetails.eventDate}</p>
                                    <p className="font-logo text-3xl font-bold golden-text">{eventDetails.eventTime}</p>
                                    <p className="text-2xl tracking-wider">{eventDetails.eventLocation}</p>
                                </div>
                                
                                <div className="text-center mb-6 bg-gray-50 p-4 rounded-lg">
                                    <p className="font-bold tracking-wider text-gray-800">DRESS CODE</p>
                                    <p className="text-lg text-gray-800 font-bold mt-1">{eventDetails.dressCodeTitle}</p>
                                    <p className="text-md text-gray-600 mt-2">{eventDetails.dressCodeDesc}</p>
                                    <p className="text-md text-gray-600 mt-2 font-semibold">{eventDetails.dressCodePalette}</p>
                                </div>

                                <div className="text-base text-gray-600 bg-gray-50 p-4 rounded-lg">
                                    <p className="font-bold mb-2 text-lg">SERVIZIO NAVETTA</p>
                                    <p className="whitespace-pre-wrap">{eventDetails.shuttleInfo}</p>
                                </div>
                                <div className="my-8 flex flex-col items-center">
                                    <div onClick={() => setIsQrModalOpen(true)} className="w-36 h-36 p-1 border-2 border-dashed border-gray-300 rounded-md bg-white cursor-pointer hover:border-yellow-500 transition">
                                       {qrDataUrl && <img src={qrDataUrl} alt="QR Code" className="w-full h-auto" />}
                                    </div>
                                    <p className="font-mono text-lg mt-2 tracking-widest bg-gray-100 px-3 py-1 rounded">{guest.shortId || guest.id.substring(0, 8).toUpperCase()}</p>
                                    <p className="text-sm text-gray-500 mt-2">Esibisci questo QR code per l'accesso.</p>
                                    <p className="text-base text-gray-600 mt-1">Valido per <span className="font-bold">{(guest.adults || 0) + (guest.children || 0)}</span> persone.</p>
                                </div>
                                <div className="text-base text-gray-600 mt-auto">
                                    <p className="whitespace-pre-wrap">{eventDetails.shuttleTiming}</p>
                                </div>

                                <div className="mt-8 border-t-2 border-dashed border-gray-300 pt-6">
                                    <h3 className="font-bold text-lg">CONFERMA PRESENZA</h3>
                                    <p className="text-sm text-gray-500">Entro il {eventDetails.rsvpDate}</p>
                                    
                                    {guest.rsvpStatus && guest.rsvpStatus !== 'pending' ? (
                                        <div className="mt-4 p-4 bg-gray-100 rounded-lg">
                                            <p className="font-bold">Grazie per la tua risposta!</p>
                                            <p>Hai indicato: <span className="font-semibold">{ {confirmed: 'Parteciperò', maybe: 'Forse', declined: 'Non parteciperò'}[guest.rsvpStatus] }</span></p>
                                            {guest.rsvpStatus === 'confirmed' && <p>per {guest.confirmedAdults} adulti e {guest.confirmedChildren} bambini.</p>}
                                            <button onClick={() => handleRsvp('pending')} className="text-sm text-indigo-600 hover:underline mt-2">Modifica risposta</button>
                                        </div>
                                    ) : (
                                        <div className="mt-4 space-y-4">
                                            <div>
                                                <p className="text-left font-semibold">Indica per quante persone confermi:</p>
                                                <div className="flex gap-4 mt-2">
                                                    <div className="flex-1">
                                                        <label className="block text-sm text-left text-gray-600">Adulti</label>
                                                        <input type="number" min="0" max={guest.adults} value={confirmedAdults} onChange={e => setConfirmedAdults(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md"/>
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="block text-sm text-left text-gray-600">Bambini</label>
                                                        <input type="number" min="0" max={guest.children} value={confirmedChildren} onChange={e => setConfirmedChildren(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex flex-col sm:flex-row gap-2">
                                                <button onClick={() => handleRsvp('confirmed')} className="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-full hover:bg-green-600">Parteciperò</button>
                                                <button onClick={() => handleRsvp('maybe')} className="flex-1 bg-yellow-500 text-white font-bold py-3 px-4 rounded-full hover:bg-yellow-600">Forse</button>
                                                <button onClick={() => handleRsvp('declined')} className="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-full hover:bg-red-600">Non ci sarò</button>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {isArrivalTime && (
                                    <div className="mt-8 border-t-2 border-dashed border-gray-300 pt-6">
                                        <h3 className="font-bold text-lg">NAVETTA ANDATA</h3>
                                        {arrivalRequestStatus === 'arrived' ? (
                                            <div className="mt-4 p-4 bg-green-100 text-green-800 rounded-lg">
                                                <p className="font-bold text-xl">La navetta è qui!</p>
                                                <p>Ti aspettiamo al punto di raccolta.</p>
                                            </div>
                                        ) : arrivalRequestStatus === 'requested' ? (
                                            <button disabled className="w-full mt-4 bg-gray-400 text-white font-bold py-3 px-6 rounded-full text-base cursor-not-allowed">
                                                Richiesta Inviata...
                                            </button>
                                        ) : (
                                            <button onClick={() => handleCallShuttle('arrival')} className="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-full text-base hover:bg-indigo-700 transition-transform hover:scale-105">
                                                Chiama Navetta per Andata
                                            </button>
                                        )}
                                    </div>
                                )}

                                {isReturnTime && (
                                    <div className="mt-8 border-t-2 border-dashed border-gray-300 pt-6">
                                        <h3 className="font-bold text-lg">NAVETTA RITORNO</h3>
                                        {returnRequestStatus === 'arrived' ? (
                                            <div className="mt-4 p-4 bg-green-100 text-green-800 rounded-lg">
                                                <p className="font-bold text-xl">La navetta è qui!</p>
                                                <p>Ti aspettiamo al punto di raccolta.</p>
                                            </div>
                                        ) : returnRequestStatus === 'requested' ? (
                                            <button disabled className="w-full mt-4 bg-gray-400 text-white font-bold py-3 px-6 rounded-full text-base cursor-not-allowed">
                                                Richiesta Inviata...
                                            </button>
                                        ) : (
                                            <button onClick={() => handleCallShuttle('return')} className="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-full text-base hover:bg-indigo-700 transition-transform hover:scale-105">
                                                Chiama Navetta per il Ritorno
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="flex justify-center gap-4 my-4">
                            <button onClick={() => handleDownload(guest)} className="flex items-center gap-2 bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg shadow-md hover:bg-gray-100 transition text-sm"><Download className="h-5 w-5"/> Salva JPG</button>
                        </div>
                        <div className="flex items-center justify-center gap-2 text-gray-500 text-sm my-4">
                            <span>Made with ❤️ by</span>
                            <MadeByLogoSVG className="h-5" />
                        </div>
                    </div>
                </React.Fragment>
            );
        };
        
        document.addEventListener('firebaseReady', () => {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<InvitationPage />);
        });
    </script>
</body>
</html>
