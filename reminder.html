<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ci siamo quasi! #LUCA30</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cormorant Garamond', serif;
            background-color: #E5E7EB;
        }
        .font-logo { font-family: 'Cinzel', serif; }
        .golden-text {
            background: -webkit-linear-gradient(45deg, #D4AF37, #C09526, #B8860B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .countdown-box {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .neon-text {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            color: #fff;
            text-shadow:
                0 0 7px #fff,
                0 0 10px #fff,
                0 0 21px #fff,
                0 0 42px #d4af37,
                0 0 82px #d4af37,
                0 0 92px #d4af37,
                0 0 102px #d4af37,
                0 0 151px #d4af37;
            animation: flicker 1.5s infinite alternate;
        }
        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% {
                text-shadow:
                0 0 4px #fff,
                0 0 11px #fff,
                0 0 19px #fff,
                0 0 40px #d4af37,
                0 0 80px #d4af37,
                0 0 90px #d4af37,
                0 0 100px #d4af37,
                0 0 150px #d4af37;
            }
            20%, 24%, 55% {        
                text-shadow: none;
            }
        }
        .confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
            animation: confetti-fall 5s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-200">
    <div id="root">
        <div class="flex items-center justify-center h-screen text-gray-600">
            <p>Caricamento reminder...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            const firebaseConfig = {
              apiKey: "AIzaSyDHt_0OZ5D-tEFj0CTKtROije15w6L1Zhc",
              authDomain: "festa-luca30-a1b2c.firebaseapp.com",
              projectId: "festa-luca30-a1b2c",
              storageBucket: "festa-luca30-a1b2c.appspot.com",
              messagingSenderId: "463454056685",
              appId: "1:463454056685:web:07287e769ce684ff9d9ce4"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.db = db;
            window.firestore = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            
            document.dispatchEvent(new CustomEvent('firebaseReady'));

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('root').innerHTML = `<div class="p-4 text-center bg-red-100 text-red-800">Errore di configurazione.</div>`;
        }
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const FinalLogoSVG = (props) => ( <svg id="Livello_2" data-name="Livello 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 977.46 688.95" {...props}><defs><linearGradient id="Sfumatura_senza_nome_11" data-name="Sfumatura senza nome 11" x1="647.58" y1="543.71" x2="647.58" y2="126.7" gradientUnits="userSpaceOnUse"><stop offset="0" stopColor="#a1722a"/><stop offset=".1" stopColor="#a97b31"/><stop offset=".46" stopColor="#c29746"/><stop offset=".77" stopColor="#d1a853"/><stop offset="1" stopColor="#d7af58"/></linearGradient><linearGradient id="Sfumatura_senza_nome_10" data-name="Sfumatura senza nome 10" x1="275.45" y1="543.9" x2="275.45" y2="126.7" gradientUnits="userSpaceOnUse"><stop offset="0" stopColor="#a1722a"/><stop offset="1" stopColor="#d7af58"/></linearGradient></defs><g id="Livello_1-2" data-name="Livello 1"><g><g><g opacity=".6"><g><path fill="#c9af8a" d="M914.34,113.94c-117.08-159.75-352.91-126.96-448.12,37.95-14.98,25.94-34.9,73.69-37.18,103.28-.36,4.71-1.41,7.97,2.21,11.99,2.59,2.88,32.71,18.56,40.19,23.8,21.38,14.99,40,33.11,60.75,48.78-6.29-106.85,25.82-304.01,173.19-280.26,114.48,18.45,160.75,162.27,164.13,263.03,31.02-24.63,65.12-45.02,102.32-58.99-4.9-51.83-26.45-107.24-57.48-149.59Z"/><path fill="#c9af8a" d="M448.52,329.91l44.33,35.65c9.59,13.24,35.67,27.29,42.86,40.84,4.77,8.99,7.81,41.26,11.46,55.01,18.69,70.27,74.22,153.05,153.58,159.08,107.63,8.18,151-99.96,163.49-188.74,1.98-14.08,.52-34.22,2.83-46.41,1.85-9.76,48.54-42.39,59.24-49.08,16.05-10.05,32.96-18.42,50.29-26.03,6.97,107.14-28.26,221.24-110.75,293-104.67,91.06-270.26,86.48-364.45-17.26-7.97-8.78-27.97-33.78-32.87-43.5-1.46-2.9-3.31-5.32-2.33-8.84,18.17-47.86,20.63-107.11,4.54-155.8-5.56-16.82-14.99-31.91-22.23-47.91Z"/></g></g><g><path opacity=".6" fill="#c9af8a" d="M83.5,96.61l224.66-3.03-182.16,219.07c27.78-.49,54.07-4.13,81.85.64,134.37,23.08,153.31,212.31,70.3,291.82.81.43,1.55,1,2.17,1.72,1.45,1.66,2.1,3.87,1.77,6.05l-1.76,11.74,2.72.12c4.03.17,7.21,3.5,7.18,7.54l-.05,8.54c-.02,4.1-3.33,7.41-7.42,7.46l-6.63.07-.51,2.93c2.13-.09,3.82-.16,5.35.1.24.04.48.1.71.16,5.24-1.91,10.41-3.97,15.5-6.18v-34.59c0-4.14,3.36-7.5,7.5-7.5h10c4.14,0,7.5,3.36,7.5,7.5v22.17c8.76-4.96,17.18-10.42,25.19-16.4,145.71-108.76,101.75-338.75-94.46-345.81-15.23-.55-30.94,3.56-44.44,2.61-3.69-.26-7.15,1.85-6.12-3.69L414.02,14.8c-7.99-1.31-15.49,2.25-23.27,2.55-80.84,3.12-180.75,4.26-261.16,0-13.75-.73-32.58-2.71-45.94-5.76C70.57,8.6,60.08.46,47.23,0L15.29,152.51l21.69,2.19c8.51-17.33,26.38-54.44,46.51-58.09Z"/><path fill="#c9af8a" d="M256.27,624.24l.4-2.55c-1.21.74-2.43,1.45-3.67,2.15l-.04.4h3.3Z"/><path fill="#c9af8a" d="M252.11,648.24h-2.9c-.23,1-.49,2.01-.75,3h3.25l.4-3Z"/><path opacity=".6" fill="#c9af8a" d="M210.18,666.79l-.04-7.34c0-.58.06-1.16.19-1.72,1.51-6.55,8.2-7.49,14.68-7.53l.23-1.95h-4.56c-2.13,0-4.16-.91-5.58-2.5s-2.1-3.71-1.87-5.82l.22-1.97c-21.2,3.76-45.27,2.7-72.14-4.55-62.66-16.91-86.45-77.55-96.8-135.84-6.72.23-21.21-3.27-23.9,3.91-3.7,35.63-16.37,72.89-19.85,108.14-.46,4.66-1.99,12.27,1.28,15.95,2.6,2.92,32.63,17.36,38.6,19.88,50.86,21.54,111.49,29.61,169.69,22.77-.09-.46-.14-.94-.15-1.43Z"/></g><g><path fill="url(#Sfumatura_senza_nome_11)" d="M410.21,126.7l112.06,4.44,121.93,314.56,121.5-315.01,110.51-3.99-.14,12.86c-19.13,5.26-41.94.99-47.99,24.51-4.76,18.52-1.13,40.23-.83,59.09,1.23,77.44,2.96,154.7,6,232,.62,15.73-1.81,46.49,6.1,59.9,6.87,11.63,32.14,11.96,44.2,13.8,3.4,1.07-.69,11.49.66,14.85l-66.46-4.05h-34.08s-63.53,3.61-63.53,3.61l-.79-1.22.79-12.92c13.12-2.85,39.87-1.66,46.24-15.76,5.92-13.12,2.14-45.96,1.84-61.18-1.58-80.15-1.85-163.1-7-243-.29-4.44,1.59-11.69-2-14.49l-133.67,346.05-13.87-1.02-129.47-336.02c-.74,19.49-.51,39.03-.97,58.54-1.17,49.58-2.34,99.23-3,149-.35,26.1-3.11,53.68-.91,79.83,2.82,33.63,23.68,34.04,51.93,38.07l.95,13.57c-31.99-.17-63.99-4.86-96.01-2.01-.65-.66,2.63-16.74,3.24-18.26s6.23-5.91,8.17-8.83c12.64-19.03,9.65-50.48,10.55-72.45,2.6-63.97,4.07-127.82,5-192,.32-21.82,5.18-66.34-2.78-85.14-8.73-20.64-28.53-20.45-48.18-23.32v-14Z"/><path fill="url(#Sfumatura_senza_nome_10)" d="M230.21,520.7c33.08-1.38,67.62,1.82,100.54.04,11.01-.6,25-2.55,35.14-6.86,30.86-13.12,43.9-60.45,55.45-89.04.78-.5,9.63.58,11.37.88,1.51.26,1.54-.72,1.53,1.49l-23.66,115.36c-4.28.13-8.63.31-12.91.17-90.19-3.01-179.79-3.12-269.95-.03-2.52.09-9.3,2.58-11.07.05l.5-13.63c24.5-4,43.64-.39,47.95-30.05,2.49-107.79.57-215.86.99-323.75-2.7-32.05-21.09-30.89-47.82-35.68l-.06-12.96,58.46,4.05h45.09s59.46-4.05,59.46-4.05v12.99c-13.04,2.47-37.81,2.89-45.83,14.68-2.29,3.36-5.17,12.96-5.17,16.83v349.5Z"/></g></g><g><path fill="#c9ad88" d="M238.68,666.74l-3.01,20.99h-8.99s3-20.99,3-20.99h-12.01s-.04-7.34-.04-7.34c.58-2.52,11.75-1.45,14.03-1.67l2.01-16.99h-13s.99-9.01.99-9.01h13.99s2.94-19.56,2.94-19.56l8.07-.44-2,20h18l3.14-19.86,8.86-.13-3,19.99,11.06.47-.05,8.54-12.86.13-2.88,16.41c.47,2.67,10.25,1.02,12.74,1.45l-1.67,8.04-12.89.9-4.1,20.1-7.34-.04,3-21h-18ZM260.68,640.74h-18c.25,4.36-2.93,12.08-2.81,15.74.04,1.22.38,1.55,1.31,2.26h16l1.31-1.69,2.19-16.31Z"/><path fill="#c9ad88" d="M619.68,688.74l-11.53-.96-8.08-20.09-40.73.02-8.13,19.08-11.53.96,35.15-77.83c3.37.02,8.5-1.45,10.73,1.44l34.1,77.39ZM595.68,658.74l-15.01-36c-7.61,10.63-11.47,24.15-16.99,36h32Z"/><path fill="#c9ad88" d="M722.44,610c50.73-7.37,48.88,86.8.19,78.29-32.66-5.71-33.08-73.51-.19-78.29ZM724.41,618.98c-18.27,3.35-18.24,35.93-12.51,49.04,6.86,15.67,26.41,15.74,33.65.1,7.55-16.32,4.22-53.79-21.15-49.14Z"/><path fill="#c9ad88" d="M382.68,610.74v50.5c0,1.25,2.89,7.72,3.81,9.19,8.02,12.89,29.87,11.87,37.23-1.15.52-.92,2.96-6.65,2.96-7.04v-51.5h10v50.5c0,1.82-3.09,9.81-4.18,11.82-10.98,20.27-44.59,21.46-55.65,1-1.09-2.02-4.18-10-4.18-11.82v-51.5h10Z"/><path fill="#c9ad88" d="M631.68,619.74l.14-8.86c1.06-.52,2.26-.89,3.44-1.04,8.39-1.07,32.61-1.18,40.97-.15,3.27.4,3.76,1.06,3.53,4.55-.29,4.51-23.67,27.4-22.08,28.49,17.33-.52,29.84,14.58,22.9,31.41-8.25,20-39.78,18.15-52.43,3.6l8.02-7.02c9.74,14.98,40.36,11.83,35.29-10.27-.86-3.75-9-9.71-12.29-9.71h-14.5l.52-6.98,19.48-24.02h-33Z"/><path fill="#c9ad88" d="M491.44,610c14-2.02,28.53.42,38.17,11.38l-6.43,7.34c-16.16-19.32-49.9-9.74-52.49,15.53-3.32,32.39,30.38,46.44,53.35,25.56l6.62,6.43c-31.89,29.61-81.7,3.9-68.48-40.5,3.6-12.09,16.67-23.92,29.26-25.74Z"/><polygon fill="#c9ad88" points="314.68 610.74 314.68 678.74 355.68 678.74 355.68 687.74 304.68 687.74 304.68 610.74 314.68 610.74"/></g></g></g></svg> );

        const Confetti = () => {
            const confettiCount = 150;
            const colors = ['#f5e6ca', '#d4af37', '#fff8e1']; // Beige, Gold, Cream White
            
            return (
                <div className="confetti-container">
                    {Array.from({ length: confettiCount }).map((_, i) => (
                        <div
                            key={i}
                            className="confetti"
                            style={{
                                backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                                left: `${Math.random() * 100}%`,
                                animationDelay: `${Math.random() * 4}s`,
                                transform: `rotate(${Math.random() * 360}deg)`
                            }}
                        ></div>
                    ))}
                </div>
            );
        };

        const ReminderPage = () => {
            const [guest, setGuest] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [qrDataUrl, setQrDataUrl] = useState('');
            const [timeLeft, setTimeLeft] = useState({});
            const [countdownFinished, setCountdownFinished] = useState(false);

            const calculateTimeLeft = () => {
                const difference = +new Date('2025-08-02T20:30:00') - +new Date();
                let timeLeft = {};

                if (difference > 0) {
                    timeLeft = {
                        giorni: Math.floor(difference / (1000 * 60 * 60 * 24)),
                        ore: Math.floor((difference / (1000 * 60 * 60)) % 24),
                        minuti: Math.floor((difference / 1000 / 60) % 60),
                        secondi: Math.floor((difference / 1000) % 60)
                    };
                } else {
                    setCountdownFinished(true);
                }
                return timeLeft;
            };

            useEffect(() => {
                const timer = setTimeout(() => {
                    setTimeLeft(calculateTimeLeft());
                }, 1000);
                return () => clearTimeout(timer);
            });

            useEffect(() => {
                const { getDoc, doc } = window.firestore;
                const params = new URLSearchParams(window.location.search);
                const guestId = params.get('id');

                if (!guestId) {
                    setError('ID invitato non trovato.');
                    setLoading(false);
                    return;
                }

                const fetchGuest = async () => {
                    try {
                        const guestRef = doc(window.db, "guests", guestId);
                        const guestSnap = await getDoc(guestRef);

                        if (guestSnap.exists()) {
                            const guestData = { id: guestSnap.id, ...guestSnap.data() };
                            setGuest(guestData);
                            generateQrCode(guestData.id);
                        } else {
                            setError("Invito non valido.");
                        }
                    } catch (err) {
                        setError("Errore nel caricamento.");
                    } finally {
                        setLoading(false);
                    }
                };

                fetchGuest();
            }, []);

            const generateQrCode = (id) => {
                try {
                    const qr = qrcode(0, 'M');
                    qr.addData(id);
                    qr.make();
                    setQrDataUrl(qr.createDataURL(5, 10));
                } catch (e) { console.error("QR Code generation failed", e); }
            };
            
            if (loading) return null;
            if (error) return <div className="flex items-center justify-center h-screen p-4 text-center bg-red-100 text-red-700">{error}</div>;
            if (!guest) return null;

            return (
                <div className="min-h-screen p-4 flex flex-col items-center justify-center">
                    <div className="w-full max-w-md bg-white shadow-2xl rounded-lg flex flex-col text-center text-gray-700 relative overflow-hidden">
                        {countdownFinished && <Confetti />}
                        <div className="px-8 sm:px-10 py-6 flex-grow flex flex-col">
                            <div className="w-1/3 mx-auto mt-4"><FinalLogoSVG /></div>
                            
                            {countdownFinished ? (
                                <div className="flex-grow flex flex-col items-center justify-center my-12">
                                    <h2 className="neon-text">Let's Party!</h2>
                                </div>
                            ) : (
                                <React.Fragment>
                                    <div className="mt-8 text-xl">
                                        <p>Ciao <span className="font-bold">{guest.name}</span>,</p>
                                        <p className="mt-4 text-lg text-gray-600">
                                            Ci siamo quasi! Ho lucidato gli stivali (scherzo, bastano scarpe comode!) e non vedo l'ora di festeggiare con te. Manca pochissimo!
                                        </p>
                                    </div>
                                    <div className="my-8">
                                        <div className="grid grid-cols-4 gap-2 text-center">
                                            {Object.keys(timeLeft).map(interval => (
                                                <div key={interval} className="countdown-box p-3 rounded-lg">
                                                    <p className="font-logo text-3xl font-bold text-gray-800">{timeLeft[interval]}</p>
                                                    <p className="text-xs uppercase text-gray-600">{interval}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="mt-auto flex flex-col items-center">
                                        <p className="text-sm text-gray-500 mb-2">Il tuo codice personale:</p>
                                        <div className="w-36 h-36 p-1 border-2 border-dashed border-gray-300 rounded-md bg-white">
                                           {qrDataUrl && <img src={qrDataUrl} alt="QR Code" className="w-full h-auto" />}
                                        </div>
                                        <p className="font-mono text-lg mt-2 tracking-widest bg-gray-100 px-3 py-1 rounded">{guest.shortId || guest.id.substring(0, 8).toUpperCase()}</p>
                                    </div>
                                </React.Fragment>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        document.addEventListener('firebaseReady', () => {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<ReminderPage />);
        });
    </script>
</body>
</html>
