<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Roboto', sans-serif; } </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <div id="iframe-container" style="display: none;"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            const firebaseConfig = {
              apiKey: "AIzaSyDHt_0OZ5D-tEFj0CTKtROije15w6L1Zhc",
              authDomain: "festa-luca30-a1b2c.firebaseapp.com",
              projectId: "festa-luca30-a1b2c",
              storageBucket: "festa-luca30-a1b2c.appspot.com",
              messagingSenderId: "463454056685",
              appId: "1:463454056685:web:07287e769ce684ff9d9ce4"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.db = db;
            window.firestore = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

            document.dispatchEvent(new CustomEvent('firebaseReady'));

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('root').innerHTML = `<div class="p-4 text-center bg-red-100 text-red-800">Errore di configurazione Firebase. Controlla la console.</div>`;
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Icons ---
        const UserPlus = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><line x1="19" x2="19" y1="8" y2="14" /><line x1="22" x2="16" y1="11" y2="11" /></svg>);
        const Trash2 = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>);
        const Copy = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>);
        const Check = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>);
        const RefreshCw = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>);
        const Download = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>);
        const Edit2 = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>);
        const X = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>);
        const LogOut = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>);
        const Eye = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>);
        const EyeOff = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></svg>);
        const Zap = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>);
        const Star = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>);
        const Bell = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>);
        const FlaskConical = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.31"/><path d="M14 9.31V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/><path d="m16 9-1.42 1.42A3 3 0 0 0 14 12.83V16"/><path d="M8 9l1.42 1.42A3 3 0 0 1 10 12.83V16"/><path d="M6 16a6 6 0 0 0 12 0Z"/></svg>);

        const ConfirmationModal = ({ onConfirm, onCancel, title, message }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <h2 className="text-xl font-bold mb-4">{title}</h2>
                    <p className="mb-6 text-gray-600">{message}</p>
                    <div className="flex justify-end gap-4">
                        <button onClick={onCancel} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Annulla</button>
                        <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Conferma</button>
                    </div>
                </div>
            </div>
        );

        const AdminDashboard = ({ onLogout }) => {
            const [guests, setGuests] = useState([]);
            const [arrivalQueue, setArrivalQueue] = useState([]);
            const [returnQueue, setReturnQueue] = useState([]);
            const [newGuestName, setNewGuestName] = useState("");
            const [newGuestAdults, setNewGuestAdults] = useState(1);
            const [newGuestChildren, setNewGuestChildren] = useState(0);
            const [newGuestIsOrganizer, setNewGuestIsOrganizer] = useState(false);
            const [copiedInfo, setCopiedInfo] = useState({id: null, type: ''});
            const [loading, setLoading] = useState(true);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showResetQueuesConfirm, setShowResetQueuesConfirm] = useState(false);
            const [showSyncConfirm, setShowSyncConfirm] = useState(false);
            const [notification, setNotification] = useState('');
            const [editingGuestId, setEditingGuestId] = useState(null);
            const [editedData, setEditedData] = useState({ name: '', adults: 1, children: 0, status: 'In attesa', rsvpStatus: 'pending', unlimitedScans: false });
            const [searchTerm, setSearchTerm] = useState('');
            const [sortOrder, setSortOrder] = useState('date_added_desc');
            const [now, setNow] = useState(Date.now());

            useEffect(() => {
                const interval = setInterval(() => setNow(Date.now()), 30000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(''), 4000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            useEffect(() => {
                const { collection, onSnapshot, query, orderBy } = window.firestore;
                
                const guestsQuery = query(collection(window.db, "guests"));
                const unsubscribeGuests = onSnapshot(guestsQuery, (querySnapshot) => {
                    const guestsData = [];
                    querySnapshot.forEach((doc) => {
                        guestsData.push({ id: doc.id, ...doc.data() });
                    });
                    setGuests(guestsData);
                    setLoading(false);
                });

                const arrivalQuery = query(collection(window.db, "arrivalRequests"), orderBy("createdAt", "asc"));
                const unsubscribeArrival = onSnapshot(arrivalQuery, (querySnapshot) => {
                    const queueData = [];
                    querySnapshot.forEach((doc) => {
                        queueData.push({ id: doc.id, ...doc.data() });
                    });
                    setArrivalQueue(queueData);
                });

                const returnQuery = query(collection(window.db, "returnRequests"), orderBy("createdAt", "asc"));
                const unsubscribeReturn = onSnapshot(returnQuery, (querySnapshot) => {
                    const queueData = [];
                    querySnapshot.forEach((doc) => {
                        queueData.push({ id: doc.id, ...doc.data() });
                    });
                    setReturnQueue(queueData);
                });

                return () => {
                    unsubscribeGuests();
                    unsubscribeArrival();
                    unsubscribeReturn();
                };
            }, []);

            const addGuest = async () => {
                if (newGuestName.trim() === "") return;
                const { collection, doc, setDoc } = window.firestore;
                const newGuestRef = doc(collection(window.db, "guests"));
                const newId = newGuestRef.id;
                const shortId = newId.substring(0, 8).toUpperCase();

                await setDoc(newGuestRef, {
                    name: newGuestName,
                    status: "In attesa",
                    rsvpStatus: "pending",
                    adults: Number(newGuestAdults) || 1,
                    children: Number(newGuestChildren) || 0,
                    shortId: shortId,
                    unlimitedScans: newGuestIsOrganizer
                });
                setNewGuestName("");
                setNewGuestAdults(1);
                setNewGuestChildren(0);
                setNewGuestIsOrganizer(false);
            };

            const deleteGuest = async (id) => {
                const { doc, deleteDoc } = window.firestore;
                await deleteDoc(doc(window.db, "guests", id));
            };

            const handleResetStates = async () => {
                const { writeBatch, doc } = window.firestore;
                const batch = writeBatch(window.db);
                guests.forEach(guest => {
                    const guestRef = doc(window.db, "guests", guest.id);
                    batch.update(guestRef, { status: "In attesa" });
                });
                await batch.commit();
                setShowResetConfirm(false);
            };

            const handleResetQueues = async () => {
                const { collection, getDocs, writeBatch, doc } = window.firestore;
                const batch = writeBatch(window.db);
                const arrivalSnapshot = await getDocs(collection(window.db, "arrivalRequests"));
                arrivalSnapshot.forEach(doc => batch.delete(doc.ref));
                const returnSnapshot = await getDocs(collection(window.db, "returnRequests"));
                returnSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                setShowResetQueuesConfirm(false);
            };

            const handleSyncShortIds = async () => {
                const { collection, getDocs, writeBatch, doc } = window.firestore;
                const guestsRef = collection(window.db, "guests");
                const querySnapshot = await getDocs(guestsRef);
                const batch = writeBatch(window.db);
                let updates = 0;

                querySnapshot.forEach((guestDoc) => {
                    const guestData = guestDoc.data();
                    if (!guestData.shortId) {
                        const newShortId = guestDoc.id.substring(0, 8).toUpperCase();
                        const docRef = doc(window.db, "guests", guestDoc.id);
                        batch.update(docRef, { shortId: newShortId });
                        updates++;
                    }
                });

                if (updates > 0) {
                    await batch.commit();
                    setNotification(`${updates} inviti sono stati sincronizzati con successo!`);
                } else {
                    setNotification("Nessun invito da sincronizzare. È tutto a posto!");
                }
                setShowSyncConfirm(false);
            };
            
            const handleDirectDownload = (guestId) => {
                const iframeContainer = document.getElementById('iframe-container');
                const iframe = document.createElement('iframe');
                iframe.src = `/invito.html?id=${guestId}&autodownload=true`;
                iframe.style.display = 'none';
                iframe.onload = () => {
                    setTimeout(() => iframe.remove(), 2000);
                };
                iframeContainer.appendChild(iframe);
            };

            const handleTestClick = (guestId) => {
                window.open(`${window.location.origin}/invito.html?id=${guestId}&testmode=true`, '_blank');
                window.open(`${window.location.origin}/reminder.html?id=${guestId}&testmode=true`, '_blank');
            };

            const handleEdit = (guest) => {
                setEditingGuestId(guest.id);
                setEditedData({ 
                    name: guest.name, 
                    adults: guest.adults || 1, 
                    children: guest.children || 0,
                    status: guest.status,
                    rsvpStatus: guest.rsvpStatus || 'pending',
                    unlimitedScans: guest.unlimitedScans || false 
                });
            };

            const handleCancelEdit = () => {
                setEditingGuestId(null);
            };

            const handleUpdateGuest = async () => {
                if (editedData.name.trim() === "") return;
                const { doc, updateDoc } = window.firestore;
                const guestRef = doc(window.db, "guests", editingGuestId);
                await updateDoc(guestRef, {
                    name: editedData.name,
                    adults: Number(editedData.adults) || 1,
                    children: Number(editedData.children) || 0,
                    status: editedData.status,
                    rsvpStatus: editedData.rsvpStatus,
                    unlimitedScans: editedData.unlimitedScans
                });
                setEditingGuestId(null);
            };

            const copyToClipboard = (text, type, id) => {
                navigator.clipboard.writeText(text).then(() => {
                    setCopiedInfo({id, type});
                    setTimeout(() => setCopiedInfo({id: null, type: ''}), 2000);
                });
            };
            
            const getStatusPill = (status) => {
                const baseClasses = "px-3 py-1 text-sm font-semibold rounded-full text-white";
                switch (status) {
                    case 'In attesa': return `${baseClasses} bg-gray-500`;
                    case 'In viaggio': return `${baseClasses} bg-blue-500`;
                    case 'Arrivato': return `${baseClasses} bg-green-500`;
                    default: return `${baseClasses} bg-gray-400`;
                }
            };

            const getRsvpPill = (status) => {
                const baseClasses = "px-3 py-1 text-xs font-semibold rounded-full";
                 switch (status) {
                    case 'confirmed': return `${baseClasses} bg-green-200 text-green-800`;
                    case 'maybe': return `${baseClasses} bg-yellow-200 text-yellow-800`;
                    case 'declined': return `${baseClasses} bg-red-200 text-red-800`;
                    default: return `${baseClasses} bg-gray-200 text-gray-800`;
                }
            };
            
            const rsvpLabels = {
                pending: 'In attesa',
                confirmed: 'Parteciperà',
                maybe: 'Forse',
                declined: 'Non parteciperà'
            };

            const stats = useMemo(() => {
                return guests.reduce((acc, guest) => {
                    const totalInvited = (guest.adults || 0) + (guest.children || 0);
                    acc.totalInvitations++;
                    acc.totalPeopleInvited += totalInvited;
                    
                    if (guest.rsvpStatus === 'confirmed') {
                        acc.confirmedAdults += guest.confirmedAdults ?? guest.adults ?? 0;
                        acc.confirmedChildren += guest.confirmedChildren ?? guest.children ?? 0;
                    }
                    
                    if (guest.status === 'In viaggio') acc.peopleInViaggio += totalInvited;
                    if (guest.status === 'Arrivato') acc.peopleArrivati += totalInvited;

                    return acc;
                }, { 
                    totalInvitations: 0, 
                    totalPeopleInvited: 0, 
                    confirmedAdults: 0, 
                    confirmedChildren: 0,
                    peopleInViaggio: 0,
                    peopleArrivati: 0
                });
            }, [guests]);

            const peopleWaitingForArrival = arrivalQueue.reduce((acc, req) => acc + (req.adults || 0) + (req.children || 0), 0);
            const peopleWaitingForReturn = returnQueue.reduce((acc, req) => acc + (req.adults || 0) + (req.children || 0), 0);

            const displayedGuests = useMemo(() => {
                return guests
                    .filter(guest => 
                        guest.name.toLowerCase().includes(searchTerm.toLowerCase())
                    )
                    .sort((a, b) => {
                        if (sortOrder === 'name_asc') {
                            return a.name.localeCompare(b.name);
                        }
                        return b.id.localeCompare(a.id);
                    });
            }, [guests, searchTerm, sortOrder]);
            
            const formatTimeAgo = useCallback((timestamp) => {
                if (!timestamp) return '...';
                const seconds = Math.floor((now - timestamp.toDate()) / 1000);
                let interval = Math.floor(seconds / 60);
                if (interval < 1) return 'meno di un minuto';
                if (interval < 60) return `${interval} min fa`;
                interval = Math.floor(seconds / 3600);
                return `${interval} ore fa`;
            }, [now]);

            return (
                <div className="container mx-auto p-4 md:p-8">
                    {notification && (
                        <div className="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-opacity duration-300">
                            {notification}
                        </div>
                    )}
                    {showResetConfirm && <ConfirmationModal title="Conferma Reset Stati" message="Sei sicuro di voler resettare lo stato di TUTTI gli invitati a 'In attesa'?" onConfirm={handleResetStates} onCancel={() => setShowResetConfirm(false)} />}
                    {showResetQueuesConfirm && <ConfirmationModal title="Conferma Svuota Code" message="Sei sicuro di voler cancellare TUTTE le richieste di navetta per l'andata e il ritorno?" onConfirm={handleResetQueues} onCancel={() => setShowResetQueuesConfirm(false)} />}
                    {showSyncConfirm && <ConfirmationModal title="Conferma Sincronizzazione" message="Questa operazione aggiungerà un codice breve a tutti gli inviti che non ne hanno uno. È un'operazione sicura e va eseguita solo una volta. Vuoi procedere?" onConfirm={handleSyncShortIds} onCancel={() => setShowSyncConfirm(false)} />}
                    
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h1 className="text-4xl font-bold text-gray-800">Dashboard Evento</h1>
                        <div className="flex items-center gap-2 mt-4 sm:mt-0 flex-wrap">
                             <button onClick={() => setShowSyncConfirm(true)} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <Zap className="h-5 w-5" /> Sincronizza
                            </button>
                            <button onClick={() => setShowResetStatesConfirm(true)} className="bg-orange-500 text-white font-bold py-2 px-4 rounded-md hover:bg-orange-600 transition-colors flex items-center gap-2">
                                <RefreshCw className="h-5 w-5" /> Reset Stati
                            </button>
                             <button onClick={() => setShowResetQueuesConfirm(true)} className="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition-colors flex items-center gap-2">
                                <Trash2 className="h-5 w-5" /> Svuota Code
                            </button>
                             <button onClick={onLogout} className="bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-700 transition-colors flex items-center gap-2">
                                <LogOut className="h-5 w-5" /> Logout
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
                        <div className="bg-white p-4 rounded-lg shadow-md text-center"><p className="text-3xl font-bold text-gray-800">{stats.totalInvitations}</p><p className="text-gray-500">Totale Inviti</p></div>
                        <div className="bg-white p-4 rounded-lg shadow-md text-center"><p className="text-3xl font-bold text-gray-800">{stats.totalPeopleInvited}</p><p className="text-gray-500">Totale Persone</p></div>
                        <div className="bg-white p-4 rounded-lg shadow-md text-center"><p className="text-3xl font-bold text-green-500">{stats.confirmedAdults + stats.confirmedChildren}</p><p className="text-gray-500">Confermati</p></div>
                        <div className="bg-white p-4 rounded-lg shadow-md text-center"><p className="text-3xl font-bold text-indigo-500">{stats.peopleArrivati}</p><p className="text-gray-500">Arrivati</p></div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Aggiungi Invitato</h2>
                        <div className="flex flex-col sm:flex-row gap-4 items-center flex-wrap">
                            <input type="text" value={newGuestName} onChange={(e) => setNewGuestName(e.target.value)} placeholder="Nome invitato o famiglia" className="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                            <div className="flex gap-2">
                                <input type="number" value={newGuestAdults} onChange={(e) => setNewGuestAdults(parseInt(e.target.value, 10))} min="1" placeholder="Adulti" className="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 w-24"/>
                                <input type="number" value={newGuestChildren} onChange={(e) => setNewGuestChildren(parseInt(e.target.value, 10))} min="0" placeholder="Bambini" className="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 w-24"/>
                            </div>
                            <label className="flex items-center gap-2 text-gray-700">
                                <input type="checkbox" checked={newGuestIsOrganizer} onChange={(e) => setNewGuestIsOrganizer(e.target.checked)} className="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"/>
                                Organizzatore
                            </label>
                            <button onClick={addGuest} className="bg-indigo-600 text-white font-bold py-3 px-6 rounded-md hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                                <UserPlus className="h-5 w-5" /> Aggiungi
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Coda Navetta Andata ({peopleWaitingForArrival} persone)</h2>
                            {arrivalQueue.length === 0 ? <p className="text-gray-500">Nessuno in attesa.</p> : (
                                <ul className="space-y-3 max-h-60 overflow-y-auto">
                                    {arrivalQueue.map(req => (
                                        <li key={req.id} className={`p-3 rounded-lg flex justify-between items-center ${req.status === 'arrived' ? 'bg-green-100' : 'bg-blue-50'}`}>
                                            <div>
                                                <span className="font-bold text-gray-800">{req.guestName}</span>
                                                <span className="text-sm text-gray-600 ml-2">({req.adults}A, {req.children}B) - {formatTimeAgo(req.createdAt)}</span>
                                            </div>
                                            <span className={`px-3 py-1 text-sm font-semibold rounded-full text-white ${req.status === 'arrived' ? 'bg-green-500' : 'bg-blue-500'}`}>{req.status === 'arrived' ? 'Notificato' : 'In attesa'}</span>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Coda Navetta Ritorno ({peopleWaitingForReturn} persone)</h2>
                            {returnQueue.length === 0 ? <p className="text-gray-500">Nessuno in attesa.</p> : (
                                <ul className="space-y-3 max-h-60 overflow-y-auto">
                                    {returnQueue.map(req => (
                                        <li key={req.id} className={`p-3 rounded-lg flex justify-between items-center ${req.status === 'arrived' ? 'bg-green-100' : 'bg-blue-50'}`}>
                                            <div>
                                                <span className="font-bold text-gray-800">{req.guestName}</span>
                                                <span className="text-sm text-gray-600 ml-2">({req.adults}A, {req.children}B) - {formatTimeAgo(req.createdAt)}</span>
                                            </div>
                                            <span className={`px-3 py-1 text-sm font-semibold rounded-full text-white ${req.status === 'arrived' ? 'bg-green-500' : 'bg-blue-500'}`}>{req.status === 'arrived' ? 'Notificato' : 'In attesa'}</span>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Lista Invitati ({displayedGuests.length})</h2>
                        <div className="flex flex-col md:flex-row gap-4 mb-4">
                            <div className="flex-grow">
                                <input type="text" placeholder="Cerca per nome..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="text-gray-600">Ordina per:</span>
                                <button onClick={() => setSortOrder('date_added_desc')} className={`px-4 py-2 rounded-md text-sm ${sortOrder === 'date_added_desc' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800'}`}>Aggiunta</button>
                                <button onClick={() => setSortOrder('name_asc')} className={`px-4 py-2 rounded-md text-sm ${sortOrder === 'name_asc' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800'}`}>Alfabetico</button>
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codice Breve</th>
                                        <th className="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Persone</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RSVP</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato Check-in</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {loading ? (
                                        <tr><td colSpan="6" className="text-center p-4">Caricamento...</td></tr>
                                    ) : displayedGuests.map(guest => (
                                        <tr key={guest.id} className={guest.unlimitedScans ? 'bg-yellow-50' : ''}>
                                            {editingGuestId === guest.id ? (
                                                <>
                                                    <td className="px-6 py-4">
                                                        <input type="text" value={editedData.name} onChange={(e) => setEditedData({...editedData, name: e.target.value})} className="p-1 border border-gray-300 rounded-md w-full"/>
                                                        <label className="flex items-center gap-2 text-gray-700 mt-2">
                                                            <input type="checkbox" checked={editedData.unlimitedScans} onChange={(e) => setEditedData({...editedData, unlimitedScans: e.target.checked})} className="h-4 w-4 rounded text-indigo-600"/> Organizzatore
                                                        </label>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500">{guest.shortId || 'N/A'}</td>
                                                    <td className="px-2 py-4">
                                                        <input type="number" value={editedData.adults} onChange={(e) => setEditedData({...editedData, adults: parseInt(e.target.value, 10)})} className="p-1 border border-gray-300 rounded-md w-16 text-center mb-1" placeholder="A"/>
                                                        <input type="number" value={editedData.children} onChange={(e) => setEditedData({...editedData, children: parseInt(e.target.value, 10)})} className="p-1 border border-gray-300 rounded-md w-16 text-center" placeholder="B"/>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <select value={editedData.rsvpStatus} onChange={(e) => setEditedData({...editedData, rsvpStatus: e.target.value})} className="p-1.5 border border-gray-300 rounded-md w-full">
                                                            <option value="pending">In attesa</option>
                                                            <option value="confirmed">Parteciperà</option>
                                                            <option value="maybe">Forse</option>
                                                            <option value="declined">Non parteciperà</option>
                                                        </select>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <select value={editedData.status} onChange={(e) => setEditedData({...editedData, status: e.target.value})} className="p-1.5 border border-gray-300 rounded-md w-full">
                                                            <option value="In attesa">In attesa</option>
                                                            <option value="In viaggio">In viaggio</option>
                                                            <option value="Arrivato">Arrivato</option>
                                                        </select>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium flex items-center gap-2">
                                                        <button onClick={handleUpdateGuest} title="Conferma" className="text-green-600 p-2 rounded-md hover:bg-green-100"><Check className="h-5 w-5"/></button>
                                                        <button onClick={handleCancelEdit} title="Annulla" className="text-red-600 p-2 rounded-md hover:bg-red-100"><X className="h-5 w-5"/></button>
                                                    </td>
                                                </>
                                            ) : (
                                                <>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center gap-2">
                                                        {guest.name}
                                                        {guest.unlimitedScans && <Star className="h-4 w-4 text-yellow-500 fill-current" title="Organizzatore" />}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500">{guest.shortId || 'N/A'}</td>
                                                    <td className="px-2 py-4 whitespace-nowrap text-sm text-gray-900 text-center font-bold">{(guest.adults || 0) + (guest.children || 0)}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap"><span className={getRsvpPill(guest.rsvpStatus)}>{rsvpLabels[guest.rsvpStatus || 'pending']}</span></td>
                                                    <td className="px-6 py-4 whitespace-nowrap"><span className={getStatusPill(guest.status)}>{guest.status}</span></td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium flex items-center gap-2 flex-wrap">
                                                        <button onClick={() => copyToClipboard(`${window.location.origin}/invito.html?id=${guest.id}`, 'invite', guest.id)} title="Copia link invito" className="bg-gray-200 p-2 rounded-md hover:bg-gray-300">{copiedInfo.id === guest.id && copiedInfo.type === 'invite' ? <Check className="h-5 w-5 text-green-600" /> : <Copy className="h-5 w-5" />}</button>
                                                        <button onClick={() => copyToClipboard(`${window.location.origin}/reminder.html?id=${guest.id}`, 'reminder', guest.id)} title="Copia link reminder" className="bg-purple-100 text-purple-600 p-2 rounded-md hover:bg-purple-200">{copiedInfo.id === guest.id && copiedInfo.type === 'reminder' ? <Check className="h-5 w-5 text-green-600" /> : <Bell className="h-5 w-5" />}</button>
                                                        <button onClick={() => handleTestClick(guest.id)} title="Apri link di test" className="bg-orange-100 text-orange-600 p-2 rounded-md hover:bg-orange-200"><FlaskConical className="h-5 w-5" /></button>
                                                        <a href={`/invito.html?id=${guest.id}`} target="_blank" title="Visualizza invito" className="bg-blue-100 text-blue-600 p-2 rounded-md hover:bg-blue-200"><Eye className="h-5 w-5" /></a>
                                                        <button onClick={() => handleDirectDownload(guest.id)} title="Scarica invito JPG" className="bg-green-100 text-green-600 p-2 rounded-md hover:bg-green-200"><Download className="h-5 w-5" /></button>
                                                        <button onClick={() => handleEdit(guest)} title="Modifica invitato" className="text-yellow-600 p-2 rounded-md hover:bg-yellow-100"><Edit2 className="h-5 w-5"/></button>
                                                        <button onClick={() => deleteGuest(guest.id)} title="Elimina invitato" className="text-red-600 p-2 rounded-md hover:bg-red-100"><Trash2 className="h-5 w-5" /></button>
                                                    </td>
                                                </>
                                            )}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        
        const LoginScreen = ({ onLogin }) => {
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [error, setError] = useState('');
            const ADMIN_PASS = "LUCA30ADMIN";

            const handleLogin = () => {
                if (password === ADMIN_PASS) onLogin();
                else setError('Password non corretta.');
            };

            return (
                 <div className="min-h-screen bg-gray-800 flex items-center justify-center p-4">
                    <div className="w-full max-w-sm p-8 bg-gray-900 rounded-lg shadow-lg">
                        <h1 className="text-3xl font-bold text-center text-white mb-6">Accesso Dashboard</h1>
                        <div className="space-y-4">
                            <div className="relative">
                                <input 
                                    type={showPassword ? "text" : "password"}
                                    placeholder="Password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyUp={(e) => e.key === 'Enter' && handleLogin()}
                                    className="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 pr-10"
                                />
                                <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                                    {showPassword ? <EyeOff /> : <Eye />}
                                </button>
                            </div>
                            <button onClick={handleLogin} className="w-full p-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition-colors">Entra</button>
                            {error && <p className="text-red-500 text-center mt-2">{error}</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loggedIn = localStorage.getItem('dashboardLoggedIn');
                if (loggedIn === 'true') {
                    setIsLoggedIn(true);
                }
                setLoading(false);
            }, []);

            const handleLogin = () => {
                localStorage.setItem('dashboardLoggedIn', 'true');
                setIsLoggedIn(true);
            };

            const handleLogout = () => {
                localStorage.removeItem('dashboardLoggedIn');
                setIsLoggedIn(false);
            };
            
            if (loading || !window.db || !window.firestore) {
                return <div className="flex items-center justify-center h-screen text-gray-600"><p>Caricamento...</p></div>;
            }

            if (!isLoggedIn) {
                return <LoginScreen onLogin={handleLogin} />;
            }
            
            return <AdminDashboard onLogout={handleLogout} />;
        };

        document.addEventListener('firebaseReady', () => {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        });
    </script>
</body>
</html>
