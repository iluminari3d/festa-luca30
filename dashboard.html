<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Roboto', sans-serif; } </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyDHt_0OZ5D-tEFj0CTKtROije15w6L1Zhc",
              authDomain: "festa-luca30-a1b2c.firebaseapp.com",
              projectId: "festa-luca30-a1b2c",
              storageBucket: "festa-luca30-a1b2c.appspot.com",
              messagingSenderId: "463454056685",
              appId: "1:463454056685:web:07287e769ce684ff9d9ce4"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.db = db;
            window.firestore = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('root').innerHTML = `<div class="p-4 text-center bg-red-100 text-red-800">Errore di configurazione Firebase. Controlla la console.</div>`;
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons ---
        const UserPlus = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><line x1="19" x2="19" y1="8" y2="14" /><line x1="22" x2="16" y1="11" y2="11" /></svg>);
        const Trash2 = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>);
        const Copy = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>);
        const Check = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>);

        // --- Dashboard Component ---
        const AdminDashboard = () => {
            const [guests, setGuests] = useState([]);
            const [newGuestName, setNewGuestName] = useState("");
            const [copiedId, setCopiedId] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!window.db || !window.firestore) return;
                const { collection, onSnapshot, query } = window.firestore;
                
                const q = query(collection(window.db, "guests"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const guestsData = [];
                    querySnapshot.forEach((doc) => {
                        guestsData.push({ id: doc.id, ...doc.data() });
                    });
                    setGuests(guestsData);
                    setLoading(false);
                }, (error) => {
                    console.error("Error listening to guests collection:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            const addGuest = async () => {
                if (newGuestName.trim() === "") return;
                const { collection, addDoc } = window.firestore;
                try {
                    await addDoc(collection(window.db, "guests"), {
                        name: newGuestName,
                        status: "In attesa"
                    });
                    setNewGuestName("");
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            };

            const deleteGuest = async (id) => {
                const { doc, deleteDoc } = window.firestore;
                try {
                    await deleteDoc(doc(window.db, "guests", id));
                } catch (e) {
                     console.error("Error deleting document: ", e);
                }
            };

            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopiedId(text);
                    setTimeout(() => setCopiedId(null), 2000);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);
            };
            
            const getStatusPill = (status) => {
                const baseClasses = "px-3 py-1 text-sm font-semibold rounded-full text-white";
                switch (status) {
                    case 'In attesa': return `${baseClasses} bg-gray-500`;
                    case 'In viaggio': return `${baseClasses} bg-blue-500`;
                    case 'Arrivato': return `${baseClasses} bg-green-500`;
                    default: return `${baseClasses} bg-gray-400`;
                }
            };

            const stats = guests.reduce((acc, guest) => {
                acc[guest.status] = (acc[guest.status] || 0) + 1;
                acc.total++;
                return acc;
            }, { total: 0, 'In attesa': 0, 'In viaggio': 0, 'Arrivato': 0 });

            return (
                <div className="container mx-auto p-4 md:p-8">
                    <h1 className="text-4xl font-bold text-gray-800 mb-6">Dashboard Evento</h1>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div className="bg-white p-4 rounded-lg shadow-md text-center">
                            <p className="text-3xl font-bold text-gray-800">{stats.total}</p>
                            <p className="text-gray-500">Invitati Totali</p>
                        </div>
                        <div className="bg-white p-4 rounded-lg shadow-md text-center">
                            <p className="text-3xl font-bold text-gray-500">{stats['In attesa']}</p>
                            <p className="text-gray-500">In Attesa</p>
                        </div>
                        <div className="bg-white p-4 rounded-lg shadow-md text-center">
                            <p className="text-3xl font-bold text-blue-500">{stats['In viaggio']}</p>
                            <p className="text-gray-500">In Viaggio</p>
                        </div>
                        <div className="bg-white p-4 rounded-lg shadow-md text-center">
                            <p className="text-3xl font-bold text-green-500">{stats['Arrivato']}</p>
                            <p className="text-gray-500">Arrivati</p>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Aggiungi Invitato</h2>
                        <div className="flex flex-col sm:flex-row gap-4">
                            <input
                                type="text"
                                value={newGuestName}
                                onChange={(e) => setNewGuestName(e.target.value)}
                                placeholder="Nome invitato o famiglia"
                                className="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <button onClick={addGuest} className="bg-indigo-600 text-white font-bold py-3 px-6 rounded-md hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                                <UserPlus className="h-5 w-5" /> Aggiungi
                            </button>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow-md overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link Invito</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {loading ? (
                                    <tr><td colSpan="4" className="text-center p-4">Caricamento...</td></tr>
                                ) : guests.length === 0 ? (
                                    <tr><td colSpan="4" className="text-center p-4 text-gray-500">Nessun invitato ancora.</td></tr>
                                ) : (
                                    guests.map(guest => {
                                        const invitationLink = `${window.location.origin}/invito.html?id=${guest.id}`;
                                        return (
                                            <tr key={guest.id}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{guest.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap"><span className={getStatusPill(guest.status)}>{guest.status}</span></td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    <button onClick={() => copyToClipboard(invitationLink)} className="bg-gray-200 p-2 rounded-md hover:bg-gray-300 transition-colors">
                                                        {copiedId === invitationLink ? <Check className="h-5 w-5 text-green-600" /> : <Copy className="h-5 w-5" />}
                                                    </button>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onClick={() => deleteGuest(guest.id)} className="text-red-600 hover:text-red-900 p-2 rounded-md hover:bg-red-100">
                                                        <Trash2 className="h-5 w-5" />
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        
        const LoginScreen = ({ onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const ADMIN_PASS = "LUCA30ADMIN";

            const handleLogin = () => {
                if (password === ADMIN_PASS) {
                    onLogin();
                } else {
                    setError('Password non corretta.');
                }
            };

            return (
                 <div className="min-h-screen bg-gray-800 flex items-center justify-center p-4">
                    <div className="w-full max-w-sm p-8 bg-gray-900 rounded-lg shadow-lg">
                        <h1 className="text-3xl font-bold text-center text-white mb-6">Accesso Dashboard</h1>
                        <div className="space-y-4">
                            <input 
                                type="password"
                                placeholder="Password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                onKeyUp={(e) => e.key === 'Enter' && handleLogin()}
                                className="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <button 
                                onClick={handleLogin}
                                className="w-full p-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition-colors"
                            >
                                Entra
                            </button>
                            {error && <p className="text-red-500 text-center mt-2">{error}</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            
            if (!window.db || !window.firestore) {
                return <div className="text-center p-4">Caricamento...</div>;
            }

            if (!isLoggedIn) {
                return <LoginScreen onLogin={() => setIsLoggedIn(true)} />;
            }
            
            return <AdminDashboard />;
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
