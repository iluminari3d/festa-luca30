<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scanner Evento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        .scanner-container video { width: 100% !important; height: auto !important; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="root">
        <div class="flex items-center justify-center h-screen text-white">
            <p>Caricamento scanner...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        try {
            const firebaseConfig = {
              apiKey: "AIzaSyDHt_0OZ5D-tEFj0CTKtROije15w6L1Zhc",
              authDomain: "festa-luca30-a1b2c.firebaseapp.com",
              projectId: "festa-luca30-a1b2c",
              storageBucket: "festa-luca30-a1b2c.appspot.com",
              messagingSenderId: "463454056685",
              appId: "1:463454056685:web:07287e769ce684ff9d9ce4"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            window.db = db;
            window.firestore = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            
            document.dispatchEvent(new CustomEvent('firebaseReady'));

        } catch (e) {
            console.error("Firebase initialization or authentication failed:", e);
            document.getElementById('root').innerHTML = `<div class="min-h-screen flex items-center justify-center text-center text-white bg-red-800 p-4"><div><h1 class="text-2xl font-bold">Errore di Configurazione Firebase</h1></div></div>`;
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const QrCode = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 11V5a2 2 0 0 1 2-2h6"/><path d="M11 3h10a2 2 0 0 1 2 2v6"/><path d="M21 13v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-8"/><path d="M3 11h18"/><path d="M9 7v.01"/><path d="M15 7v.01"/><path d="M9 17v.01"/><path d="M15 17v.01"/></svg>);
        const CheckCircle = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>);
        const XCircle = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>);
        const LogOut = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>);

        const ScannerScreen = ({ user, onLogout }) => {
            const [message, setMessage] = useState({ text: '', type: '' });
            const scannerRef = useRef(null);
            const { role, username } = user;

            useEffect(() => {
                const html5QrCode = new Html5Qrcode("qr-reader");
                scannerRef.current = html5QrCode;

                const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                    if (decodedText) {
                        html5QrCode.pause();
                        await handleScan(decodedText);
                        setTimeout(() => {
                            setMessage({ text: '', type: '' });
                            if (scannerRef.current && scannerRef.current.getState() === 2) {
                                html5QrCode.resume();
                            }
                        }, 4000);
                    }
                };

                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                    .catch(err => {
                        console.log(`Unable to start scanning, error: ${err}`)
                        setMessage({ text: 'Impossibile avviare la fotocamera.', type: 'error' });
                    });
                
                return () => {
                    if (scannerRef.current && scannerRef.current.isScanning) {
                        scannerRef.current.stop().catch(err => console.log("Failed to stop scanner", err));
                    }
                };
            }, []);

            const handleScan = async (guestId) => {
                const { getDoc, doc, updateDoc } = window.firestore;
                const guestRef = doc(window.db, "guests", guestId);
                
                try {
                    const guestSnap = await getDoc(guestRef);

                    if (!guestSnap.exists()) {
                        setMessage({ text: 'CODICE NON VALIDO', type: 'error' });
                        return;
                    }

                    const guestData = guestSnap.data();
                    let successMessage = '';
                    
                    if (role === 'Rider') {
                        if (guestData.status === 'In attesa') {
                            await updateDoc(guestRef, { status: 'In viaggio', scannedBy: username });
                            successMessage = `ACCESSO NAVETTA VALIDO\n${guestData.name}`;
                        } else {
                            setMessage({ text: `STATO NON VALIDO: ${guestData.status.toUpperCase()}\n(${guestData.name})`, type: 'error' });
                            return;
                        }
                    } else if (role === 'Security') {
                        if (guestData.status === 'In viaggio' || guestData.status === 'In attesa') {
                             await updateDoc(guestRef, { status: 'Arrivato', scannedBy: username });
                             successMessage = `BENVENUTO/A!\n${guestData.name}`;
                        } else if (guestData.status === 'Arrivato') {
                             setMessage({ text: `ACCESSO GIÃ€ EFFETTUATO\n(${guestData.name})`, type: 'error' });
                             return;
                        } else {
                             setMessage({ text: `STATO NON VALIDO: ${guestData.status.toUpperCase()}\n(${guestData.name})`, type: 'error' });
                             return;
                        }
                    }

                    setMessage({ text: successMessage, type: 'success' });

                } catch (error) {
                    console.error("Error handling scan:", error);
                    setMessage({ text: 'Errore di sistema.', type: 'error' });
                }
            };
            
            const getRoleName = () => role === 'Rider' ? 'Autista Navetta' : 'Security';

            return (
                <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md mx-auto">
                        <div className="flex justify-between items-center mb-4">
                           <div>
                             <h1 className="text-2xl font-bold text-white">{getRoleName()}</h1>
                             <p className="text-gray-400">{username}</p>
                           </div>
                           <button onClick={onLogout} className="text-gray-400 hover:text-white p-2 rounded-full bg-gray-800"><LogOut /></button>
                        </div>

                        <div id="qr-reader" className="w-full scanner-container bg-gray-800 rounded-lg overflow-hidden"></div>
                        
                        {message.text && (
                            <div className={`mt-6 p-6 rounded-lg text-center text-white text-2xl font-bold whitespace-pre-wrap transition-all duration-300 ${message.type === 'success' ? 'bg-green-500' : 'bg-red-600'}`}>
                                {message.type === 'success' ? <CheckCircle className="w-12 h-12 mx-auto mb-2" /> : <XCircle className="w-12 h-12 mx-auto mb-2" />}
                                {message.text}
                            </div>
                        )}
                        
                        {!message.text && (
                             <div className="mt-6 p-6 rounded-lg text-center text-gray-400 bg-gray-800">
                                <QrCode className="w-12 h-12 mx-auto mb-2" />
                                <p className="text-lg">Inquadra un QR code per validare l'accesso.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const users = [
                { username: 'MARIAGIOVANNA', password: 'NAVETTA30A', role: 'Rider' },
                { username: 'MIMMO', password: 'NAVETTA30B', role: 'Rider' },
                { username: 'SECURITY', password: 'LUCA30PARTY', role: 'Security' }
            ];

            const handleLogin = () => {
                const upperCaseUsername = username.toUpperCase();
                const user = users.find(u => u.username === upperCaseUsername && u.password === password);

                if (user) {
                    onLogin(user);
                } else {
                    setError('Username o password non corretti.');
                }
            };

            return (
                <div className="min-h-screen bg-gray-800 flex items-center justify-center p-4">
                    <div className="w-full max-w-sm p-8 bg-gray-900 rounded-lg shadow-lg">
                        <h1 className="text-3xl font-bold text-center text-white mb-6">Accesso Operatori</h1>
                        <div className="space-y-4">
                            <input
                                type="text"
                                placeholder="Username"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                onKeyUp={(e) => e.key === 'Enter' && handleLogin()}
                                className="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <input 
                                type="password"
                                placeholder="Password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                onKeyUp={(e) => e.key === 'Enter' && handleLogin()}
                                className="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <button 
                                onClick={handleLogin}
                                className="w-full p-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition-colors disabled:bg-gray-500"
                                disabled={!username || !password}
                            >
                                Entra
                            </button>
                            {error && <p className="text-red-500 text-center mt-2">{error}</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            
            if (!window.db || !window.firestore) {
                return null;
            }

            const handleLogin = (loggedInUser) => {
                setUser(loggedInUser);
            };

            const handleLogout = () => {
                setUser(null);
            };

            if (!user) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            return <ScannerScreen user={user} onLogout={handleLogout} />;
        };

        document.addEventListener('firebaseReady', () => {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        });
    </script>
</body>
</html>
